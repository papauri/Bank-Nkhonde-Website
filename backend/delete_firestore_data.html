<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firestore Data Deletion</title>
    <script type="module">
        // Firebase Setup
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import {
            getFirestore,
            collection,
            getDocs,
            deleteDoc,
            doc,
            deleteField,
            updateDoc,
        } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        import {
            getAuth,
            deleteUser,
        } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyClJfGFoc1WZ_qYi5ImQJXyurQtqXgOqfA",
            authDomain: "banknkonde.firebaseapp.com",
            projectId: "banknkonde",
            storageBucket: "banknkonde.appspot.com",
            messagingSenderId: "698749180404",
            appId: "1:698749180404:web:7e8483cae4abd7555101a1",
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // Recursively delete all documents in a collection and its known subcollections
        async function deleteCollection(collectionName, subcollections = []) {
            const collectionRef = collection(db, collectionName);
            const snapshot = await getDocs(collectionRef);
            const batchSize = snapshot.size;

            if (batchSize === 0) {
                alert(`The ${collectionName} collection is already empty.`);
                return;
            }

            let deleteCount = 0;
            const promises = [];

            // Delete each document and check for known subcollections
            snapshot.forEach(async (docSnapshot) => {
                promises.push(deleteDocumentWithSubcollections(docSnapshot.ref, subcollections));
                deleteCount++;
            });

            // Wait for all promises to complete
            await Promise.all(promises);
            alert(`Successfully deleted ${deleteCount} documents from the ${collectionName} collection.`);
        }

        // Delete document and all its known subcollections
        async function deleteDocumentWithSubcollections(docRef, subcollections) {
            // Loop through each subcollection to delete
            for (const subcollection of subcollections) {
                const subcollectionRef = collection(docRef, subcollection);
                const subcollectionSnapshot = await getDocs(subcollectionRef);
                subcollectionSnapshot.forEach(async (subDocSnapshot) => {
                    await deleteDoc(subDocSnapshot.ref);
                });
            }

            // Now delete the main document
            await deleteDoc(docRef);
        }

        // Delete all group-related subcollections (members, payments, loans, etc.)
        async function deleteGroupData(groupId) {
            const groupRef = doc(db, "groups", groupId);
            const subcollections = [
                "members", // Group members subcollection
                "payments", // Payments related to the group
                "loans", // Loan records under the group
            ];

            // Delete group-specific documents and subcollections
            await deleteDocumentWithSubcollections(groupRef, subcollections);
        }

        // Delete all user data in Firestore and the user from Firebase Authentication
        async function deleteUserData(userId, groupId) {
            const userDocRef = doc(db, "users", userId);

            // First, delete the user's group data
            await deleteGroupData(groupId); // This deletes all group data for the specific group

            // Now delete the user document
            await deleteDoc(userDocRef);

            // Delete the user from Firebase Authentication
            const user = auth.currentUser;
            if (user && user.uid === userId) {
                await deleteUser(user);
                alert("User has been deleted from Firebase Authentication.");
            }
        }

        // Delete All Collections (Groups, Users, Invitation Codes)
        async function deleteAllCollections() {
            if (confirm("Are you sure you want to delete all collections?")) {
                await deleteCollection("groups", ["members", "payments", "loans"]);
                await deleteCollection("users", []); // Assuming users have no subcollections
                await deleteCollection("invitationCodes", []); // Assuming invitationCodes have no subcollections
                alert("All specified collections have been deleted.");
            }
        }

        // Attach Functions to Buttons
        document.addEventListener("DOMContentLoaded", () => {
            document.getElementById("deleteGroups").addEventListener("click", () => {
                const groupId = prompt("Enter the Group ID to delete:");
                if (groupId) {
                    if (confirm(`Are you sure you want to delete all documents in the 'groups' collection for Group ID: ${groupId}?`)) {
                        deleteGroupData(groupId);
                    }
                }
            });

            document.getElementById("deleteInvitationCodes").addEventListener("click", () => {
                if (confirm("Are you sure you want to delete all documents in the 'invitationCodes' collection?")) {
                    deleteCollection("invitationCodes", []);
                }
            });

            document.getElementById("deleteUsers").addEventListener("click", () => {
                const userId = prompt("Enter the User ID to delete:");
                const groupId = prompt("Enter the Group ID related to the user:");
                if (userId && groupId) {
                    if (confirm(`Are you sure you want to delete the user with ID: ${userId} and their group data?`)) {
                        deleteUserData(userId, groupId);
                    }
                }
            });

            document.getElementById("deleteAll").addEventListener("click", deleteAllCollections);
        });
    </script>
</head>

<body>
    <h1>Firestore Data Deletion</h1>
    <p>Use the buttons below to delete documents from Firestore collections instantly. Proceed with caution.</p>

    <button id="deleteGroups">Delete All Groups</button>
    <button id="deleteInvitationCodes">Delete All Invitation Codes</button>
    <button id="deleteUsers">Delete All Users</button>
    <hr>
    <button id="deleteAll">Delete All Collections</button>
</body>

</html>
